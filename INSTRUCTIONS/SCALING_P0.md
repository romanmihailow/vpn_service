# Минимальные правки для устойчивости при всплеске

## Введение
Цель — точечные, безопасные изменения без смены архитектуры, чтобы сервис не упал при резком росте пользователей. Фокус: синхронный PostgreSQL, WireGuard (IP/конфиг), /start и выдача VPN при конкуренции, блокирующие операции.

## P0 (критично, сделать первым)

### 1) PostgreSQL: нет пула соединений
- Описание: `app/db.py` использует `get_conn()` в каждой функции → новое соединение на каждый запрос.
- Что ломается при нагрузке: исчерпание лимита соединений, рост latency, ошибки `connection limit exceeded`.
- Минимальное исправление: добавить простой пул (например `psycopg2.pool.ThreadedConnectionPool`) и использовать `get_conn()` как borrow/return из пула.
- Почему безопасно: бизнес-логика не меняется, только способ получения соединения.
- Эффект: меньше соединений, стабильнее БД.

### 2) WireGuard: гонки при записи `wg0.conf`
- Описание: `app/wg.py` — `_append_peer_to_config` и `_remove_peer_from_config` пишут файл без lock.
- Что ломается при нагрузке: повреждение конфигурации, пропажа peer.
- Минимальное исправление: добавить file lock (например `fcntl.flock`) и атомарную запись (temp + rename) для удаления.
- Почему безопасно: только защита записи, формат и логика неизменны.
- Эффект: устранение гонок при параллельной выдаче.

### 3) /start и выдача VPN: гонки IP/peer
- Описание: выдача IP через `generate_client_ip()` (линейный перебор), запись в БД и wg — без транзакционной блокировки.
- Что ломается при нагрузке: дубли IP, конфликт peer, ошибка в wg.
- Минимальное исправление: в момент выдачи IP/создания подписки добавлять блокировку на уровне БД (advisory lock или `SELECT ... FOR UPDATE` в таблице IP/подписок).
- Почему безопасно: не меняет бизнес-логику, только последовательность доступа.
- Эффект: исключение дублей при конкуренции.

## P1 (желательно)

### 4) WireGuard: линейная аллокация IP деградирует
- Описание: `app/wg.py` — `generate_client_ip()` перебирает IP и проверяет `is_vpn_ip_used()`.
- Что ломается при нагрузке: рост времени выдачи, ошибки при заполнении пула.
- Минимальное исправление: в БД хранить таблицу свободных IP и выбирать следующий через `SELECT ... FOR UPDATE SKIP LOCKED`.
- Почему безопасно: структура выдачи та же, но без линейного перебора.
- Эффект: стабильная выдача IP при росте.

### 5) Блокирующие subprocess и файловые операции
- Описание: `app/wg.py` — `generate_keypair()` и `add_peer/remove_peer()` вызывают `subprocess.run`, блокируя event loop.
- Что ломается при нагрузке: задержки обработки апдейтов.
- Минимальное исправление: вынести эти вызовы в `asyncio.to_thread` или `run_in_executor`.
- Почему безопасно: логика не меняется, только выполнение.
- Эффект: снижение блокировок event loop.

## P2 (можно позже)

### 6) /start и выдача VPN: повторные апдейты
- Описание: при повторном `/start` может пересоздаваться подписка/peer (зависит от текущей логики в `tg_bot_runner.py`).
- Что ломается при нагрузке: лишние операции, повторная выдача.
- Минимальное исправление: идемпотентная проверка активной подписки перед выдачей (если уже есть — не создавать новую).
- Почему безопасно: не меняет бизнес-логику, только защита от дублей.
- Эффект: снижение нагрузки при повторных командах.


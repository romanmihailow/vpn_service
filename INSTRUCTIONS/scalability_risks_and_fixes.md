# –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å: —Ä–∏—Å–∫–∏ –∏ –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## –í–≤–µ–¥–µ–Ω–∏–µ
–°–µ—Ä–≤–∏—Å ‚Äî Telegram-–±–æ—Ç –Ω–∞ `aiogram`, –≤—ã–¥–∞—é—â–∏–π VPN (WireGuard) –∏ —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –ø–æ–¥–ø–∏—Å–∫–∞–º–∏, –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏, —Ä–µ—Ñ–µ—Ä–∞–ª–∫–æ–π –∏ –±–∞–ª–ª–∞–º–∏. –ó–∞–ø—É—Å–∫ –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (`docker-compose`), –Ω–∞ –æ–¥–Ω–æ–º VPS (2 vCPU / 2 GB RAM / 30 GB NVMe). –ë–∞–∑–∞ ‚Äî PostgreSQL –Ω–∞ —Ö–æ—Å—Ç–µ. –í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è: webhook-—Å–µ—Ä–≤–µ—Ä (aiohttp), polling –±–æ—Ç–∞ –∏ —Ñ–æ–Ω–æ–≤—ã–µ —Ü–∏–∫–ª—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫.

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ä–∏—Å–∫–∏ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –∏ –æ–ø–∏—Å—ã–≤–∞–µ—Ç, —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä–æ –∏ —á—Ç–æ –ª—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ.

## –ö—Ä–∏—Ç–∏—á–Ω–æ (üî¥ ‚Äî —Å–ª–æ–º–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º)

### 1) –ù–µ—Ç –ø—É–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ PostgreSQL
- –ì–¥–µ: `app/db.py` ‚Äî –ø–æ—á—Ç–∏ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–∑—ã–≤–∞—é—Ç `get_conn()` (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å).
- –°—Ü–µ–Ω–∞—Ä–∏–π: —Ä–æ—Å—Ç —á–∏—Å–ª–∞ —Å–æ–±—ã—Ç–∏–π (–æ–ø–ª–∞—Ç—ã, —Ä–∞—Å—Å—ã–ª–∫–∏, —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞, —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏).
- –°–∏–º–ø—Ç–æ–º—ã: —Ä–æ—Å—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞, –æ—à–∏–±–∫–∏ `connection limit exceeded`, –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ë–î.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: —á–∞—Å—Ç–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π -> –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã + –∏—Å—á–µ—Ä–ø–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ø—É–ª (psycopg2.pool / pgbouncer / asyncpg).
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –≤—ã–Ω–µ—Å—Ç–∏ –ë–î –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ö–æ—Å—Ç —Å –±–æ–ª—å—à–∏–º–∏ –ª–∏–º–∏—Ç–∞–º–∏, –Ω–æ —ç—Ç–æ –ø–æ–ª—É–º–µ—Ä–∞.
- –ë—ã—Å—Ç—Ä–æ: –ø–æ—Å—Ç–∞–≤–∏—Ç—å pgbouncer —Ä—è–¥–æ–º –∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å max connections –≤ –ë–î.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø—É–ª –≤ –∫–æ–¥–µ –∏–ª–∏ –Ω–∞ async DB.

### 2) –û–¥–Ω–æ–ø—Ä–æ—Ü–µ—Å—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ + SPOF
- –ì–¥–µ: `Dockerfile`, `docker-compose.yml`, `app/tg_bot_runner.py` (polling + webhook + —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ).
- –°—Ü–µ–Ω–∞—Ä–∏–π: —Ä–æ—Å—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞.
- –°–∏–º–ø—Ç–æ–º—ã: –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏ –ª—é–±–æ–º –ø–∞–¥–µ–Ω–∏–∏/—É—Ç–µ—á–∫–µ.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä = –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ—Ç–∫–∞–∑–∞; –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–æ –∏–∑-–∑–∞ `network_mode: host`.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –≤—ã–¥–µ–ª–∏—Ç—å —Ä–æ–ª–∏ (–±–æ—Ç/polling, webhooks, —Ñ–æ–Ω–æ–≤—ã–µ –≤–æ—Ä–∫–µ—Ä—ã), —É–±—Ä–∞—Ç—å `network_mode: host`.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –æ—Å—Ç–∞–≤–∏—Ç—å `host` –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ (–¥–æ—Ä–æ–≥–æ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ).
- –ë—ã—Å—Ç—Ä–æ: –¥–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥/–∞–≤—Ç–æ—Ä–µ—Å—Ç–∞—Ä—Ç + –ª–∏–º–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ Docker.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã.

### 3) WireGuard –∫–æ–Ω—Ñ–∏–≥ –ø–∏—à–µ—Ç—Å—è –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- –ì–¥–µ: `app/wg.py` ‚Äî `_append_peer_to_config`, `_remove_peer_from_config`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤—ã–¥–∞—á–∞/—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫.
- –°–∏–º–ø—Ç–æ–º—ã: –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ `wg0.conf`, –ø—Ä–æ–ø–∞–∂–∞ peer, —Ä–∞–∑—Ä—ã–≤ –¥–æ—Å—Ç—É–ø–∞.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –∑–∞–ø–∏—Å—å/–ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Ñ–∞–π–ª–∞ –±–µ–∑ lock/atomic –æ–ø–µ—Ä–∞—Ü–∏–∏.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: file lock + –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å (write-temp + rename).
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: —Ö—Ä–∞–Ω–∏—Ç—å peers –≤ –ë–î –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑ `wg` –±–µ–∑ –∫–æ–Ω—Ñ–∏–≥-—Ñ–∞–π–ª–∞.
- –ë—ã—Å—Ç—Ä–æ: –¥–æ–±–∞–≤–∏—Ç—å –≤–Ω–µ—à–Ω—é—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (flock) –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø—É—Å–∫–∞.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è WireGuard.

### 4) –ú–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–¥—É—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- –ì–¥–µ: `app/tg_bot_runner.py` ‚Äî `broadcast_send`, `auto_notify_expiring_subscriptions`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: –º–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 50k –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) –∏–ª–∏ –º–Ω–æ–≥–æ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫.
- –°–∏–º–ø—Ç–æ–º—ã: –¥–ª–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞, rate-limit Telegram, –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç–∞–º.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ `send_message` –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏/–±—ç–∫–∞–ø–∞.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏ + –ª–∏–º–∏—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ + worker pool.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –≤—ã–Ω–µ—Å—Ç–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å/–≤–æ—Ä–∫–µ—Ä.
- –ë—ã—Å—Ç—Ä–æ: –ª–∏–º–∏—Ç—ã –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É + –ø–∞—É–∑—ã –∏ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ error-rate.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å (Redis/RabbitMQ).

### 5) Webhook-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç –≤—Å—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- –ì–¥–µ: `app/yookassa_webhook_runner.py`, `app/heleket_webhook_runner.py`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: –≤—Å–ø–ª–µ—Å–∫ –ø–ª–∞—Ç–µ–∂–µ–π –∏–ª–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ API.
- –°–∏–º–ø—Ç–æ–º—ã: —Ç–∞–π–º–∞—É—Ç—ã webhook, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –¥—É–±–ª—å-–æ–ø–µ—Ä–∞—Ü–∏–∏.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—á–µ—Ä–µ–¥–∏ –∏ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –±—ã—Å—Ç—Ä—ã–π ACK + –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: cron-–¥–∂–æ–±, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ API.
- –ë—ã—Å—Ç—Ä–æ: –∫–µ—à/–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ `payment_id` –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: event-driven pipeline —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é.

## –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ (üü† ‚Äî –Ω–∞—á–Ω—ë—Ç –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å)

### 6) –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ç—è–∂—ë–ª—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –ë–î –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤
- –ì–¥–µ: `app/db.py` ‚Äî `get_all_telegram_users`, `get_or_create_referral_info`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: —Ä–æ—Å—Ç —á–∏—Å–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤.
- –°–∏–º–ø—Ç–æ–º—ã: —Ä–æ—Å—Ç RAM –∏ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞, –ª–∞–≥–∏ –≤ –±–æ—Ç-–∫–æ–º–∞–Ω–¥–∞—Ö.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –≤—ã–±–æ—Ä–∫–∏ –≤ –ø–∞–º—è—Ç—å –±–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ø–∞–≥–∏–Ω–∞—Ü–∏—è –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ SQL.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏.
- –ë—ã—Å—Ç—Ä–æ: –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—ã–±–æ—Ä–∫—É –ø–æ –ª–∏–º–∏—Ç—É –¥–ª—è –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è/–º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è.

### 7) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π WireGuard ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π subprocess
- –ì–¥–µ: `app/wg.py` ‚Äî `generate_keypair`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–∏–∫ –ø–æ–¥–ø–∏—Å–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è).
- –°–∏–º–ø—Ç–æ–º—ã: —Ä–æ—Å—Ç latency, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ event-loop.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: `subprocess.run` –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –≤—ã–Ω–æ—Å–∏—Ç—å –∫–ª—é—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É–ª–∞ –∫–ª—é—á–µ–π.
- –ë—ã—Å—Ç—Ä–æ: –ª–∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–¥–∞—á—É –≤ –ø–∏–∫–µ.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

### 8) IP-–∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ª–∏–Ω–µ–π–Ω—ã–π –∏ –º–µ–¥–ª–µ–Ω–Ω–æ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç
- –ì–¥–µ: `app/wg.py` ‚Äî `generate_client_ip`, `app/db.py` ‚Äî `get_max_client_ip_last_octet`, `is_vpn_ip_used`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É–ª–∞ IP.
- –°–∏–º–ø—Ç–æ–º—ã: –¥–æ–ª–≥–∏–µ –≤—ã–¥–∞—á–∏, –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ø—É–ª–∞.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –ª–∏–Ω–µ–π–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤ –ë–î.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: —Ç–∞–±–ª–∏—Ü–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö IP + –∏–Ω–¥–µ–∫—Å + –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–¥—Å–µ—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, /22).
- –ë—ã—Å—Ç—Ä–æ: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—É–ª–∞.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å IP allocation.

### 9) N+1 –≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ü–µ–ø–æ—á–∫–µ
- –ì–¥–µ: `app/db.py` ‚Äî `get_referral_upline_chain`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏.
- –°–∏–º–ø—Ç–æ–º—ã: —Ä–æ—Å—Ç —á–∏—Å–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: —Ü–∏–∫–ª —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π SQL (CTE) –∏–ª–∏ –∫—ç—à.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: —Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ø–æ—á–∫—É –∑–∞—Ä–∞–Ω–µ–µ.
- –ë—ã—Å—Ç—Ä–æ: —É–º–µ–Ω—å—à–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É/–≥–ª—É–±–∏–Ω—É —Ä–∞—Å—á—ë—Ç–∞.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ä–µ–≤–∞.

### 10) –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –±–µ–∑ –ª–æ–∫–æ–≤
- –ì–¥–µ: `app/tg_bot_runner.py` ‚Äî `auto_deactivate_expired_subscriptions`, `auto_notify_expiring_subscriptions`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: –∑–∞–ø—É—Å–∫ –≤—Ç–æ—Ä–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏).
- –°–∏–º–ø—Ç–æ–º—ã: –¥—É–±–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –≥–æ–Ω–∫–∏ –∑–∞ —Ä–µ—Å—É—Ä—Å—ã.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –Ω–µ—Ç distributed lock.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: Redis lock / advisory lock –≤ PostgreSQL.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –≤—ã–Ω–æ—Å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π single-instance worker.
- –ë—ã—Å—Ç—Ä–æ: —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ç–µ–º, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: –æ–¥–∏–Ω –≤–æ—Ä–∫–µ—Ä + –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π.

## –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ (üü¢ ‚Äî –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω—ã–µ, –Ω–æ –≤–∞–∂–Ω—ã–µ)

### 11) –õ–æ–≥–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –±–µ–∑ —Ä–æ—Ç–∞—Ü–∏–∏
- –ì–¥–µ: `docker-compose.yml` ‚Äî volume `./logs:/app/logs`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: –¥–æ–ª–≥–∏–π –∞–ø—Ç–∞–π–º, –º–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏–π.
- –°–∏–º–ø—Ç–æ–º—ã: —Ä–æ—Å—Ç –¥–∏—Å–∫–∞, –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ IO.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –Ω–µ—Ç —Ä–æ—Ç–∞—Ü–∏–∏/TTL.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: logrotate –∏–ª–∏ –≤–Ω–µ—à–Ω—è—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–æ–≤.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: stdout + docker logging driver.
- –ë—ã—Å—Ç—Ä–æ: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å logrotate –Ω–∞ —Ö–æ—Å—Ç–µ.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏.

### 12) –ü–æ–ª–ª–∏–Ω–≥ Telegram –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
- –ì–¥–µ: `app/tg_bot_runner.py` ‚Äî `dp.start_polling(bot)`.
- –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–∏–∫–æ–≤—ã–π –ø–æ—Ç–æ–∫ –∞–ø–¥–µ–π—Ç–æ–≤.
- –°–∏–º–ø—Ç–æ–º—ã: –ª–∞–≥–∏ –≤ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã.
- –ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞: –≤—Å—ë –≤ –æ–¥–Ω–æ–º event loop.
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ webhook-only –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è polling.
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ —Å sharding (–Ω–µ —Å host network).
- –ë—ã—Å—Ç—Ä–æ: –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å rate-limit.
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∂–µ: horizontal scaling + webhook.

## –ë—ã—Å—Ç—Ä—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫)
1. –í–∫–ª—é—á–∏—Ç—å –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î (pgbouncer).
2. –í—ã–Ω–µ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É webhooks –≤ –æ—á–µ—Ä–µ–¥—å –∏–ª–∏ —Ö–æ—Ç—è –±—ã –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é.
3. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –¥–æ–±–∞–≤–∏—Ç—å rate-limit.
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤.
5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: CPU/RAM/DB connections + Telegram –æ—à–∏–±–æ–∫.

## –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –ø–ª–∞–Ω
1. –†–∞–∑–¥–µ–ª–∏—Ç—å —Ä–æ–ª–∏: bot/polling, webhooks, background workers.
2. –ü–µ—Ä–µ–µ–∑–¥ –Ω–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á (Redis/RabbitMQ) –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.
3. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å WireGuard: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è peers.
4. –ü–µ—Ä–µ–µ–∑–¥ –Ω–∞ async DB –∏–ª–∏ –ø—É–ª + –∞–≥—Ä–µ–≥–∞—Ü–∏–∏.
5. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (—É–±—Ä–∞—Ç—å `network_mode: host`).

